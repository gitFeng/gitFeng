<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Redis 数据结构 | gitfeng-blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本章主要介绍 redis 的关键数据结构的设计与实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 数据结构">
<meta property="og:url" content="http://ffeng.wang/2016/03/20/redis_struct/index.html">
<meta property="og:site_name" content="gitfeng-blog">
<meta property="og:description" content="本章主要介绍 redis 的关键数据结构的设计与实现。">
<meta property="og:updated_time" content="2016-03-31T04:35:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis 数据结构">
<meta name="twitter:description" content="本章主要介绍 redis 的关键数据结构的设计与实现。">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/avatar.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">gitfeng</a></h1>
        </hgroup>

        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/categories/随笔">随笔</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/mysql/" style="font-size: 20px;">mysql</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/科学/" style="font-size: 10px;">科学</a> <a href="/tags/美食/" style="font-size: 10px;">美食</a> <a href="/tags/阅读/" style="font-size: 10px;">阅读</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">来自 github 的 blog</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">gitfeng</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img lazy-src="/img/avatar.jpg" class="js-avatar">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">gitfeng</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/categories/随笔">随笔</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-redis_struct" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/20/redis_struct/" class="article-date">
      <time datetime="2016-03-20T07:01:00.000Z" itemprop="datePublished">2016-03-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Redis 数据结构
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>ref: <a href="http://blog.huangz.me/diary/2014/how-to-read-redis-source-code.html" target="_blank" rel="external">http://blog.huangz.me/diary/2014/how-to-read-redis-source-code.html</a></p>
<h2 id="redis__u5B57_u7B26_u4E32_-_sds"><a href="#redis__u5B57_u7B26_u4E32_-_sds" class="headerlink" title="redis 字符串 - sds"></a>redis 字符串 - sds</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * 类型别名，用于指向 sdshdr 的 buf 属性</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *sds;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 保存字符串对象的结构</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">struct</span> sdshdr &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buf 中已占用空间的长度</span></span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buf 中剩余可用空间的长度</span></span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">free</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据空间</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="u51FD_u6570_-__u83B7_u53D6_u957F_u5EA6"><a href="#u51FD_u6570_-__u83B7_u53D6_u957F_u5EA6" class="headerlink" title="函数 - 获取长度"></a>函数 - 获取长度</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * 返回 sds 实际保存的字符串的长度</span><br><span class="line"> *</span><br><span class="line"> * T = O(1)</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> size_t <span class="title">sdslen</span><span class="params">(<span class="keyword">const</span> sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> sdshdr *sh = (<span class="keyword">void</span>*)(s-(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)));</span><br><span class="line">    <span class="keyword">return</span> sh-&gt;len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="u4E0E_C_string__u6BD4_u8F83"><a href="#u4E0E_C_string__u6BD4_u8F83" class="headerlink" title="与 C string 比较"></a>与 C string 比较</h3><table>
<thead>
<tr>
<th>C 字符串</th>
<th>SDS</th>
</tr>
</thead>
<tbody>
<tr>
<td>获取字符串长度的复杂度为 O(N) 。</td>
<td>获取字符串长度的复杂度为 O(1) 。</td>
</tr>
<tr>
<td>API是不安全的，可能会造成缓冲区溢出。</td>
<td>API是安全的，不会造成缓冲区溢出。</td>
</tr>
<tr>
<td>修改字符串长度 N 次必然需要执行 N次内存重分配。</td>
<td>修改字符串长度 N 次最多需要执行 N次内存重分配。</td>
</tr>
<tr>
<td>只能保存文本数据。</td>
<td>可以保存文本或者二进制数据。</td>
</tr>
<tr>
<td>可以使用所有 \<string.h>库中的函数。</string.h></td>
<td>可以使用一部分 \<string.h>库中的函数。</string.h></td>
</tr>
</tbody>
</table>
<h2 id="redis__u94FE_u8868_-_adlist"><a href="#redis__u94FE_u8868_-_adlist" class="headerlink" title="redis 链表 - adlist"></a>redis 链表 - adlist</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 双端链表节点</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> listNode &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前置节点</span></span><br><span class="line">    <span class="keyword">struct</span> listNode *prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后置节点</span></span><br><span class="line">    <span class="keyword">struct</span> listNode *next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 节点的值</span></span><br><span class="line">    <span class="keyword">void</span> *value;</span><br><span class="line"></span><br><span class="line">&#125; listNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 双端链表迭代器</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> listIter &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前迭代到的节点</span></span><br><span class="line">    listNode *next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 迭代的方向</span></span><br><span class="line">    <span class="keyword">int</span> direction;</span><br><span class="line"></span><br><span class="line">&#125; listIter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 双端链表结构</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="built_in">list</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表头节点</span></span><br><span class="line">    listNode *head;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表尾节点</span></span><br><span class="line">    listNode *tail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 节点值复制函数</span></span><br><span class="line">    <span class="keyword">void</span> *(*dup)(<span class="keyword">void</span> *ptr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 节点值释放函数</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *ptr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 节点值对比函数</span></span><br><span class="line">    <span class="keyword">int</span> (*match)(<span class="keyword">void</span> *ptr, <span class="keyword">void</span> *key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 链表所包含的节点数量</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len;</span><br><span class="line"></span><br><span class="line">&#125; <span class="built_in">list</span>;</span><br></pre></td></tr></table></figure>
<h2 id="redis__u54C8_u5E0C_-_dict"><a href="#redis__u54C8_u5E0C_-_dict" class="headerlink" title="redis 哈希 - dict"></a>redis 哈希 - dict</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * 哈希表节点</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictEntry &#123;</span><br><span class="line">    <span class="comment">// 键</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 值</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> *val;</span><br><span class="line">        <span class="keyword">uint64_t</span> u64;</span><br><span class="line">        <span class="keyword">int64_t</span> s64;</span><br><span class="line">    &#125; v;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指向下个哈希表节点，形成链表</span></span><br><span class="line">    <span class="keyword">struct</span> dictEntry *next;</span><br><span class="line"></span><br><span class="line">&#125; dictEntry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 字典类型特定函数</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictType &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算哈希值的函数</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制键的函数</span></span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制值的函数</span></span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对比键的函数</span></span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁键的函数</span></span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁值的函数</span></span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line"></span><br><span class="line">&#125; dictType;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span><br><span class="line"> * implement incremental rehashing, for the old to the new table. */</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 哈希表</span><br><span class="line"> *</span><br><span class="line"> * 每个字典都使用两个哈希表，从而实现渐进式 rehash 。</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictht &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 哈希表数组</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 哈希表大小</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 哈希表大小掩码，用于计算索引值</span></span><br><span class="line">    <span class="comment">// 总是等于 size - 1</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该哈希表已有节点的数量</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</span><br><span class="line"></span><br><span class="line">&#125; dictht;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 字典</span><br><span class="line"> * 一般情况下，字典只使用 ht[0] 哈希表，ht[1] 哈希表只会在对 ht[0] 哈希表进行 rehash时使用。</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dict &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类型特定函数</span></span><br><span class="line">    dictType *type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 私有数据</span></span><br><span class="line">    <span class="keyword">void</span> *privdata;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 哈希表</span></span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rehash 索引</span></span><br><span class="line">    <span class="comment">// 当 rehash 不在进行时，值为 -1</span></span><br><span class="line">    <span class="keyword">int</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目前正在运行的安全迭代器的数量</span></span><br><span class="line">    <span class="keyword">int</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line"></span><br><span class="line">&#125; dict;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If safe is set to 1 this is a safe iterator, that means, you can call</span><br><span class="line"> * dictAdd, dictFind, and other functions against the dictionary even while</span><br><span class="line"> * iterating. Otherwise it is a non safe iterator, and only dictNext()</span><br><span class="line"> * should be called while iterating. */</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 字典迭代器</span><br><span class="line"> *</span><br><span class="line"> * 如果 safe 属性的值为 1 ，那么在迭代进行的过程中，</span><br><span class="line"> * 程序仍然可以执行 dictAdd 、 dictFind 和其他函数，对字典进行修改。</span><br><span class="line"> *</span><br><span class="line"> * 如果 safe 不为 1 ，那么程序只会调用 dictNext 对字典进行迭代，</span><br><span class="line"> * 而不对字典进行修改。</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictIterator &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 被迭代的字典</span></span><br><span class="line">    dict *d;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// table ：正在被迭代的哈希表号码，值可以是 0 或 1 。</span></span><br><span class="line">    <span class="comment">// index ：迭代器当前所指向的哈希表索引位置。</span></span><br><span class="line">    <span class="comment">// safe ：标识这个迭代器是否安全</span></span><br><span class="line">    <span class="keyword">int</span> table, index, safe;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// entry ：当前迭代到的节点的指针</span></span><br><span class="line">    <span class="comment">// nextEntry ：当前迭代节点的下一个节点</span></span><br><span class="line">    <span class="comment">//             因为在安全迭代器运作时， entry 所指向的节点可能会被修改，</span></span><br><span class="line">    <span class="comment">//             所以需要一个额外的指针来保存下一节点的位置，</span></span><br><span class="line">    <span class="comment">//             从而防止指针丢失</span></span><br><span class="line">    dictEntry *entry, *nextEntry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> fingerprint; <span class="comment">/* unsafe iterator fingerprint for misuse detection */</span></span><br><span class="line">&#125; dictIterator;</span><br></pre></td></tr></table></figure>
<h3 id="u54C8_u5E0C_u7B97_u6CD5"><a href="#u54C8_u5E0C_u7B97_u6CD5" class="headerlink" title="哈希算法"></a>哈希算法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用字典设置的哈希函数，计算键 key 的哈希值</span></span><br><span class="line">hash = dict-&gt;type-&gt;hashFunction(key);</span><br><span class="line"><span class="comment">//使用哈希表的 sizemask 属性和哈希值，计算出索引值</span></span><br><span class="line"><span class="comment">//根据不同场景，ht[x] 可能是 ht[0] 或 ht[1]</span></span><br><span class="line">index = hash &amp; dict-&gt;ht[x].sizemask;</span><br><span class="line"><span class="comment">//取值时</span></span><br><span class="line"><span class="keyword">return</span> dict-&gt;ht[x]-&gt;table[index]</span><br></pre></td></tr></table></figure>
<p>当字典被用作数据库的底层实现，或者哈希键的底层实现时，Redis使用 MurmurHash2算法来计算键的哈希值，这种算法的有点在于，即使输入的键是有规律的，算法仍能给出一个很好的随机分布，并且算法的计算速度也非常快。算法参考 <a href="https://github.com/aappleby/smhasher" target="_blank" rel="external">https://github.com/aappleby/smhasher</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* MurmurHash2, by Austin Appleby</span><br><span class="line"> * Note - This code makes a few assumptions about how your machine behaves -</span><br><span class="line"> * 1. We can read a 4-byte value from any address without crashing</span><br><span class="line"> * 2. sizeof(int) == 4</span><br><span class="line"> *</span><br><span class="line"> * And it has a few limitations -</span><br><span class="line"> *</span><br><span class="line"> * 1. It will not work incrementally.</span><br><span class="line"> * 2. It will not produce the same results on little-endian and big-endian</span><br><span class="line"> *    machines.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictGenHashFunction</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 'm' and 'r' are mixing constants generated offline.</span><br><span class="line">     They're not really 'magic', they just happen to work well.  */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> seed = dict_hash_function_seed;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span> m = <span class="number">0x5bd1e995</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> r = <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the hash to a 'random' value */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> h = seed ^ len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Mix 4 bytes at a time into the hash */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *data = (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(len &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> k = *(<span class="keyword">uint32_t</span>*)data;</span><br><span class="line"></span><br><span class="line">        k *= m;</span><br><span class="line">        k ^= k &gt;&gt; r;</span><br><span class="line">        k *= m;</span><br><span class="line"></span><br><span class="line">        h *= m;</span><br><span class="line">        h ^= k;</span><br><span class="line"></span><br><span class="line">        data += <span class="number">4</span>;</span><br><span class="line">        len -= <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle the last few bytes of the input array  */</span></span><br><span class="line">    <span class="keyword">switch</span>(len) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: h ^= data[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: h ^= data[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: h ^= data[<span class="number">0</span>]; h *= m;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Do a few final mixes of the hash to ensure the last few</span><br><span class="line">     * bytes are well-incorporated. */</span></span><br><span class="line">    h ^= h &gt;&gt; <span class="number">13</span>;</span><br><span class="line">    h *= m;</span><br><span class="line">    h ^= h &gt;&gt; <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="u54C8_u5E0C_u51B2_u7A81_u89E3_u51B3"><a href="#u54C8_u5E0C_u51B2_u7A81_u89E3_u51B3" class="headerlink" title="哈希冲突解决"></a>哈希冲突解决</h3><p>链地址法， dictEntry-&gt;next</p>
<h3 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h3><h4 id="u6267_u884C_u6D41_u7A0B"><a href="#u6267_u884C_u6D41_u7A0B" class="headerlink" title="执行流程"></a>执行流程</h4><p>随着操作的执行，哈希表保存的键值对会逐渐的增多或者减少，这种情况下，需要对哈希表的大小进行相应的扩展或收缩，让哈希表的负载因子维持在一个合理的范围内。</p>
<p>rehash 的操作步骤如下：</p>
<ol>
<li>为字典 ht[1]的哈希表分配空间，空间大小取决于要执行的操作，以及 ht[0]当前包含的键值对数量，即 ht[0].used的值<ul>
<li>如果是扩展操作，ht[1]的大小为第一个大于等于 ht[0].used*2 的 pow(2,n) (2的 n次方)</li>
<li>如果是收缩操作，ht[1]的大小为第一个大于等于 ht[0].used 的 pow(2,n) (2的 n次方)</li>
</ul>
</li>
<li>将ht[0]中的所有键值 rehash 到 ht[1]上：rehash指的是重新计算键的哈希值和索引值，然后将键值对放置到 ht[1]哈希表指定的位置上</li>
<li>当 ht[0] -&gt; ht[1]操作完成后，free(ht[0]), mv ht[1] -&gt; ht[0], new(ht[1])</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* Performs N steps of incremental rehashing. Returns 1 if there are still&#10; * keys to move from the old to the new hash table, otherwise 0 is returned.&#10; *&#10; * &#25191;&#34892; N &#27493;&#28176;&#36827;&#24335; rehash &#12290;&#10; *&#10; * &#36820;&#22238; 1 &#34920;&#31034;&#20173;&#26377;&#38190;&#38656;&#35201;&#20174; 0 &#21495;&#21704;&#24076;&#34920;&#31227;&#21160;&#21040; 1 &#21495;&#21704;&#24076;&#34920;&#65292;&#10; * &#36820;&#22238; 0 &#21017;&#34920;&#31034;&#25152;&#26377;&#38190;&#37117;&#24050;&#32463;&#36801;&#31227;&#23436;&#27605;&#12290;&#10; *&#10; * Note that a rehashing step consists in moving a bucket (that may have more&#10; * than one key as we use chaining) from the old to the new hash table.&#10; *&#10; * &#27880;&#24847;&#65292;&#27599;&#27493; rehash &#37117;&#26159;&#20197;&#19968;&#20010;&#21704;&#24076;&#34920;&#32034;&#24341;&#65288;&#26742;&#65289;&#20316;&#20026;&#21333;&#20301;&#30340;&#65292;&#10; * &#19968;&#20010;&#26742;&#37324;&#21487;&#33021;&#20250;&#26377;&#22810;&#20010;&#33410;&#28857;&#65292;&#10; * &#34987; rehash &#30340;&#26742;&#37324;&#30340;&#25152;&#26377;&#33410;&#28857;&#37117;&#20250;&#34987;&#31227;&#21160;&#21040;&#26032;&#21704;&#24076;&#34920;&#12290;&#10; *&#10; * T = O(N)&#10; */&#10;int dictRehash(dict *d, int n) &#123;&#10;&#10;    // &#21482;&#21487;&#20197;&#22312; rehash &#36827;&#34892;&#20013;&#26102;&#25191;&#34892;&#10;    if (!dictIsRehashing(d)) return 0;&#10;&#10;    // &#36827;&#34892; N &#27493;&#36801;&#31227;&#10;    // T = O(N)&#10;    while(n--) &#123;&#10;        dictEntry *de, *nextde;&#10;&#10;        /* Check if we already rehashed the whole table... */&#10;        // &#22914;&#26524; 0 &#21495;&#21704;&#24076;&#34920;&#20026;&#31354;&#65292;&#37027;&#20040;&#34920;&#31034; rehash &#25191;&#34892;&#23436;&#27605;&#10;        // T = O(1)&#10;        if (d-&#62;ht[0].used == 0) &#123;&#10;            // &#37322;&#25918; 0 &#21495;&#21704;&#24076;&#34920;&#10;            zfree(d-&#62;ht[0].table);&#10;            // &#23558;&#21407;&#26469;&#30340; 1 &#21495;&#21704;&#24076;&#34920;&#35774;&#32622;&#20026;&#26032;&#30340; 0 &#21495;&#21704;&#24076;&#34920;&#10;            d-&#62;ht[0] = d-&#62;ht[1];&#10;            // &#37325;&#32622;&#26087;&#30340; 1 &#21495;&#21704;&#24076;&#34920;&#10;            _dictReset(&#38;d-&#62;ht[1]);&#10;            // &#20851;&#38381; rehash &#26631;&#35782;&#10;            d-&#62;rehashidx = -1;&#10;            // &#36820;&#22238; 0 &#65292;&#21521;&#35843;&#29992;&#32773;&#34920;&#31034; rehash &#24050;&#32463;&#23436;&#25104;&#10;            return 0;&#10;        &#125;&#10;&#10;        /* Note that rehashidx can&#39;t overflow as we are sure there are more&#10;         * elements because ht[0].used != 0 */&#10;        // &#30830;&#20445; rehashidx &#27809;&#26377;&#36234;&#30028;&#10;        assert(d-&#62;ht[0].size &#62; (unsigned)d-&#62;rehashidx);&#10;&#10;        // &#30053;&#36807;&#25968;&#32452;&#20013;&#20026;&#31354;&#30340;&#32034;&#24341;&#65292;&#25214;&#21040;&#19979;&#19968;&#20010;&#38750;&#31354;&#32034;&#24341;&#10;        while(d-&#62;ht[0].table[d-&#62;rehashidx] == NULL) d-&#62;rehashidx++;&#10;&#10;        // &#25351;&#21521;&#35813;&#32034;&#24341;&#30340;&#38142;&#34920;&#34920;&#22836;&#33410;&#28857;&#10;        de = d-&#62;ht[0].table[d-&#62;rehashidx];&#10;        /* Move all the keys in this bucket from the old to the new hash HT */&#10;        // &#23558;&#38142;&#34920;&#20013;&#30340;&#25152;&#26377;&#33410;&#28857;&#36801;&#31227;&#21040;&#26032;&#21704;&#24076;&#34920;&#10;        // T = O(1)&#10;        while(de) &#123;&#10;            unsigned int h;&#10;&#10;            // &#20445;&#23384;&#19979;&#20010;&#33410;&#28857;&#30340;&#25351;&#38024;&#10;            nextde = de-&#62;next;&#10;&#10;            /* Get the index in the new hash table */&#10;            // &#35745;&#31639;&#26032;&#21704;&#24076;&#34920;&#30340;&#21704;&#24076;&#20540;&#65292;&#20197;&#21450;&#33410;&#28857;&#25554;&#20837;&#30340;&#32034;&#24341;&#20301;&#32622;&#10;            h = dictHashKey(d, de-&#62;key) &#38; d-&#62;ht[1].sizemask;&#10;&#10;            // &#25554;&#20837;&#33410;&#28857;&#21040;&#26032;&#21704;&#24076;&#34920;&#10;            de-&#62;next = d-&#62;ht[1].table[h];&#10;            d-&#62;ht[1].table[h] = de;&#10;&#10;            // &#26356;&#26032;&#35745;&#25968;&#22120;&#10;            d-&#62;ht[0].used--;&#10;            d-&#62;ht[1].used++;&#10;&#10;            // &#32487;&#32493;&#22788;&#29702;&#19979;&#20010;&#33410;&#28857;&#10;            de = nextde;&#10;        &#125;&#10;        // &#23558;&#21018;&#36801;&#31227;&#23436;&#30340;&#21704;&#24076;&#34920;&#32034;&#24341;&#30340;&#25351;&#38024;&#35774;&#20026;&#31354;&#10;        d-&#62;ht[0].table[d-&#62;rehashidx] = NULL;&#10;        // &#26356;&#26032; rehash &#32034;&#24341;&#10;        d-&#62;rehashidx++;&#10;    &#125;&#10;&#10;    return 1;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u89E6_u53D1_u6761_u4EF6"><a href="#u89E6_u53D1_u6761_u4EF6" class="headerlink" title="触发条件"></a>触发条件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//&#36127;&#36733;&#22240;&#23376; = &#21704;&#24076;&#34920;&#24050;&#20445;&#23384;&#33410;&#28857;&#25968;/&#21704;&#24076;&#34920;&#22823;&#23567;&#10;laod_factor = ht[0].used / ht[0].size</span><br></pre></td></tr></table></figure>
<p>满足下面任意一个条件，触发哈希表的扩展操作</p>
<ol>
<li>服务器目前没有在执行 BGSAVE 命令或 BGREWRITEAOF 命令，且哈希表的负载因子大于等于1</li>
<li>服务器目前在执行 BGSAVE 命令或 BGREWRITEAOF 命令，且哈希表的负载因子大于等于5</li>
</ol>
<p>根据 BGSAVE 命令或 BGREWRITEAOF 命令是否正在执行， 服务器执行扩展操作所需的负载因子并不相同， 这是因为在执行 BGSAVE 命令或 BGREWRITEAOF 命令的过程中， Redis 需要创建当前服务器进程的子进程， 而大多数操作系统都采用写时复制（copy-on-write）技术来优化子进程的使用效率， 所以在子进程存在期间， 服务器会提高执行扩展操作所需的负载因子， 从而尽可能地避免在子进程存在期间进行哈希表扩展操作， 这可以避免不必要的内存写入操作， 最大限度地节约内存。</p>
<p>负载因子小于0.1时，程序自动对哈希表进行收紧操作。</p>
<h3 id="u6E10_u8FDB_u5F0F_rehash"><a href="#u6E10_u8FDB_u5F0F_rehash" class="headerlink" title="渐进式 rehash"></a>渐进式 rehash</h3>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/03/28/redis_code_list/">
                    Redis 类功能 list
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/02/21/nginx_config/">
                    Nginx 配置解释
                </a>
            </div>
        
    </nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis__u5B57_u7B26_u4E32_-_sds"><span class="toc-number">1.</span> <span class="toc-text">redis 字符串 - sds</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#u51FD_u6570_-__u83B7_u53D6_u957F_u5EA6"><span class="toc-number">1.1.</span> <span class="toc-text">函数 - 获取长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u4E0E_C_string__u6BD4_u8F83"><span class="toc-number">1.2.</span> <span class="toc-text">与 C string 比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis__u94FE_u8868_-_adlist"><span class="toc-number">2.</span> <span class="toc-text">redis 链表 - adlist</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis__u54C8_u5E0C_-_dict"><span class="toc-number">3.</span> <span class="toc-text">redis 哈希 - dict</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#u54C8_u5E0C_u7B97_u6CD5"><span class="toc-number">3.1.</span> <span class="toc-text">哈希算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u54C8_u5E0C_u51B2_u7A81_u89E3_u51B3"><span class="toc-number">3.2.</span> <span class="toc-text">哈希冲突解决</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rehash"><span class="toc-number">3.3.</span> <span class="toc-text">rehash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#u6267_u884C_u6D41_u7A0B"><span class="toc-number">3.3.1.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u89E6_u53D1_u6761_u4EF6"><span class="toc-number">3.3.2.</span> <span class="toc-text">触发条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u6E10_u8FDB_u5F0F_rehash"><span class="toc-number">3.4.</span> <span class="toc-text">渐进式 rehash</span></a></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>




<div class="share">
    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
    <a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
    <a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
    </div>
    <script>
        window._bd_share_config={
            "common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>
</div>



    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2016/03/20/redis_struct/" data-title="Redis 数据结构" data-url="http://ffeng.wang/2016/03/20/redis_struct/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"gitfeng"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/03/28/redis_code_list/" title="上一篇: Redis 类功能 list">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/02/21/nginx_config/" title="下一篇: Nginx 配置解释">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/29/linux_shell_awk/">Linux_命令-awk</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/28/redis_code_list/">Redis 类功能 list</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/20/redis_struct/">Redis 数据结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/nginx_config/">Nginx 配置解释</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/20/http_base/">HTTP 协议</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/20/http_1.1/">HTTP 1.1 升级说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/28/redis_read_code/">如何阅读 Redis 源码</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/24/read_tech_2016/">2015最美科学阅读：用20本科学图书，温暖这个寒冬</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/24/food_luzhu/">百年祖传秘方_君臣佐使_卤煮</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/18/mysql_opti_rand/">MySQL_查询优化-2/2</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/useful/">有用的网站</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/php_traverse_file/">php_遍历文件内容</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_opti_write/">MySQL_写入优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_opti_storage_blob/">MySQL_存储优化-InnoDB表BLOB列</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_concurrency/">MySQL_并发控制</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_opti_misc/">MySQL_查询优化-1/2</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_join/">MySQL_JOIN</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_innodb/">MySQL_innoDB</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_explain/">MySQL_explain 的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/mysql_5.7_new/">MySQL_5.7部分新特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/chrome_plugin/">常用 chrome 插件</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/16/github_hexo/">GitHub+hexo 搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/16/FirstPage/">Hello Hexo</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/01/17/hexo_theme/">hexo 配置及主题</a></li></ul>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 gitfeng
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
            </div>
        </div>
        <div class="visit">
            <span id="busuanzi_container_site_pv" style='display:none'>
                <span id="site-visit" >本站到访数: 
                    <span id="busuanzi_value_site_uv"></span>
                </span>
            </span>
            <span id="busuanzi_container_page_pv" style='display:none'>
                <span id="page-visit">, 本页阅读量: 
                    <span id="busuanzi_value_page_pv"></span>
                </span>
            </span>
        </div>
    </div>
</footer>
    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <style>
        body {
          background: lightgray;
        }
        #container .left-col {
          background: white;
        }
        .article-inner {
          background: white;
          margin-bottom: 1em;
        }
        .post-nav-button {
          background: #ececec;
        }
        #header .header-nav .social #GitHub {
          background-color: #bfd3ec;
        }
        #post-nav-button a {
          background: rgba(215, 216, 215, .2);
        }
        .post-list {
          background: white;
        }
    </style>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>